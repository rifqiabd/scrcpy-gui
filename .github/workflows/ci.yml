name: CI Build

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build-linux:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    - name: Install Qt
      run: |
        pip install aqtinstall
        aqt install-qt linux desktop 6.5.0 gcc_64
        echo "Qt6_DIR=$PWD/Qt/6.5.0/gcc_64/lib/cmake/Qt6" >> $GITHUB_ENV
        echo "PATH=$PWD/Qt/6.5.0/gcc_64/bin:$PATH" >> $GITHUB_ENV
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake build-essential libgl1-mesa-dev
    
    - name: Configure CMake
      run: |
        mkdir build
        cd build
        cmake .. -DCMAKE_PREFIX_PATH=$Qt6_DIR
    
    - name: Build
      run: |
        cd build
        make
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: scrcpy-gui-linux
        path: build/scrcpy-gui

  build-windows:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    - name: Install Qt
      run: |
        pip install aqtinstall
        aqt install-qt windows desktop 6.5.0 win64_mingw
        echo "Qt6_DIR=$PWD/Qt/6.5.0/mingw_64/lib/cmake/Qt6" >> $env:GITHUB_ENV
        echo "PATH=$PWD/Qt/6.5.0/mingw_64/bin;$env:PATH" >> $env:GITHUB_ENV
    
    - name: Configure CMake
      run: |
        mkdir build
        cd build
        cmake -G "MinGW Makefiles" .. -DCMAKE_PREFIX_PATH=$env:Qt6_DIR
    
    - name: Build
      run: |
        cd build
        mingw32-make
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: scrcpy-gui-windows
        path: build/scrcpy-gui.exe

  build-macos:
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    - name: Install Qt
      run: |
        pip install aqtinstall
        aqt install-qt mac desktop 6.5.0 clang_64
        echo "Qt6_DIR=$PWD/Qt/6.5.0/macos/lib/cmake/Qt6" >> $GITHUB_ENV
        echo "PATH=$PWD/Qt/6.5.0/macos/bin:$PATH" >> $GITHUB_ENV
    
    - name: Install dependencies
      run: |
        brew install cmake
    
    - name: Configure CMake
      run: |
        mkdir build
        cd build
        cmake .. -DCMAKE_PREFIX_PATH=$Qt6_DIR
    
    - name: Build
      run: |
        cd build
        make
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: scrcpy-gui-macos
        path: build/scrcpy-gui
